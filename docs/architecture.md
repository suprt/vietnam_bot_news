## Общая архитектура

Ежедневная задача в GitHub Actions запускает консольное приложение на Go, которое выполняет полный цикл: сбор новостей → категоризация → отбор топ-N → суммаризация → отправка в Telegram → обновление состояния.

### Основные модули

1. **sources / scraper**
   - Ответственность: получение сырых новостей из RSS/API (при необходимости — HTML-скрейпинг).
   - Интерфейс: для каждого источника реализуется метод, возвращающий список новостей в унифицированном формате.
   - Выходные данные: нормализованный список `ArticleRaw` с полями:
     - `ID`
     - `Title`
     - `URL`
     - `Source`
     - `PublishedAt`
     - `RawContent`
     - `RawLanguage`
     - дополнительные служебные поля по мере необходимости.

2. **filtering**
   - Ответственность: предварительная фильтрация и дедупликация.
   - Функции:
     - отбрасывает слишком старые новости (старше заданного порога, например 24–48 часов);
     - отбрасывает слишком короткие или явно технические записи;
     - удаляет дубликаты по URL и/или заголовку;
     - исключает уже отправленные ранее новости, используя модуль `state`.

3. **categorization (Gemini)**
   - Ответственность: отнесение каждой новости к одной из заранее заданных категорий.
   - Особенности:
     - работает батчами для экономии токенов и запросов;
     - использует фиксированный список категорий (см. ниже);
     - ожидаемый формат ответа от модели — список объектов вида `{id, category}`.

4. **ranking (Gemini)**
   - Ответственность: выбор топ-N новостей в каждой категории на основе оценки актуальности.
   - Подход:
     - Gemini оценивает актуальность каждой новости в категории по шкале 0-10 (см. `docs/prompting.md`);
     - новости сортируются по оценке актуальности (убывание);
     - список обрезается до заданного `N` лучших (MVP: до 5 на категорию);
     - работает батчами для экономии токенов.

5. **summarization (Gemini)**
   - Ответственность: создание краткого русскоязычного резюме новости.
   - Особенности:
     - фокус на 1–2 предложения, нейтральный стиль;
     - возможно батчирование нескольких новостей в одном запросе;
     - модель читает оригинал на вьетнамском (и/или английском) и формирует текст на русском без отдельного шага перевода.

6. **formatter**
   - Ответственность: подготовка итогового текста для отправки в Telegram.
   - Формат:
     - группировка новостей по категориям;
     - для каждой новости — строка с заголовком-ссылкой (`[Заголовок](URL)`) и кратким summary;
     - итог — 1–3 сообщения, покрывающих весь дневной дайджест.

7. **telegram_sender**
   - Ответственность: отправка подготовленных сообщений в Telegram-канал.
   - Функции:
     - вызовы Telegram Bot API (`sendMessage`) с Markdown-разметкой;
     - базовый контроль лимитов и ретраи при временных ошибках.

8. **state**
   - Ответственность: хранение минимального состояния между запусками.
   - Данные:
     - список недавно отправленных новостей (например, `ID`/`URL` + дата отправки);
   - Хранилище:
     - файл в репозитории (например, `state/state.json`), обновляемый через GitHub Actions;
     - формат — JSON или YAML, пригодный для чтения/записи из Go.

9. **config**
   - Ответственность: централизованная конфигурация.
   - Содержит:
     - список источников и их RSS-URL;
     - параметры ранжирования и лимиты по количеству новостей;
     - настройки категорий и форматирования сообщений.

### Категории новостей

Фиксированный список категорий (без иерархии), из которых модель должна выбирать ровно одну для каждой новости:

- Политика
- Экономика и бизнес
- Общество
- Право и безопасность
- Технологии и наука
- Культура и развлечения
- Спорт
- Здоровье и образ жизни
- Мир (международные новости)
- Другое / Разное

- **Получатели:** формируются динамически. Любой пользователь, который написал боту (например, `/start`), попадает в список через `getUpdates`; данные хранятся в `state.state.json`. Параметр `pipeline.auto_subscribe` управляет этим поведением.
- **Вид сообщения:** как правило, один дайджест с разбивкой по категориям (при большом объёме допускается 2–3 сообщения).  
- **Структура Markdown:**
  ```
  *Категория*
  [Заголовок новости](https://example.com/news) — краткое summary на русском.
  [Следующая новость](https://example.com/next) — ещё одно краткое summary.

  *Следующая категория*
  ...
  ```
  - Заголовок всегда оформляется в квадратных скобках и содержит ссылку на оригинал.
  - Summary — 1–2 предложения, без Markdown-разметки, чтобы избежать конфликтов с символами.
  - Между категориями — пустая строка.
- **Поведение при отсутствии новостей в категории:** категория пропускается, чтобы сообщение оставалось компактным.
- **Если суммарное сообщение превышает лимит Telegram (4096 символов):**
  - делим дайджест на несколько сообщений после полного блока категории;
  - нумеруем сообщения в заголовке (например, “Подборка дня (1/2)”).
- **Force dispatch:** переменная окружения, указанная в `pipeline.force_dispatch_env` (по умолчанию `FORCE_DISPATCH`), позволяет вручную запустить рассылку даже при отсутствии зарегистрированных получателей. Удобно для тестов Telegram.

### JSON-схемы и структуры данных

| Сущность | Описание | Пример |
| --- | --- | --- |
| `ArticleRaw` | Нормализованная запись после сбора с источников. |```json
{
  "id": "tuoitre-2024-12-03-12345",
  "source": "tuoitre.vn",
  "title": "Tiêu đề gốc",
  "url": "https://tuoitre.vn/...html",
  "published_at": "2024-12-03T05:30:00+07:00",
  "raw_language": "vi",
  "raw_content": "Полный текст новости...",
  "metadata": {
    "rss_rank": 3
  }
}
```|
| `CategorizedArticle` | Результат после категоризации. |```json
{
  "article": { ...ArticleRaw },
  "category": "Экономика и бизнес",
  "category_confidence": 0.82
}
```|
| Ответ Gemini (категоризация) | LLM возвращает список `{id, category}`. |```json
[
  { "id": "tuoitre-2024-12-03-12345", "category": "Политика" },
  { "id": "vnexpress-2024-12-03-777", "category": "Технологии и наука" }
]
```|
| Ответ Gemini (summary) | LLM возвращает список `{id, summary_ru}`. |```json
[
  {
    "id": "tuoitre-2024-12-03-12345",
    "summary_ru": "Власти Вьетнама представили новый план..."
  }
]
```|
| `DigestEntry` | Итоговая запись перед форматированием. |```json
{
  "id": "tuoitre-2024-12-03-12345",
  "category": "Политика",
  "title": "Tiêu đề gốc",
  "url": "https://tuoitre.vn/...html",
  "summary_ru": "Власти Вьетнама представили новый план...",
  "source": "tuoitre.vn",
  "published_at": "2024-12-03T05:30:00+07:00"
}
```|
| `state/state.json` | Список уже отправленных новостей и связанные получатели. |```json
{
  "last_run": "2024-12-03T06:00:00Z",
  "sent_articles": [
    {
      "id": "tuoitre-2024-12-03-12345",
      "sent_at": "2024-12-03T06:05:10Z"
    }
  ],
  "recipients": [
    {
      "name": "primary-user",
      "chat_id": "123456789",
      "updated_at": "2024-12-03T05:59:00Z"
    }
  ],
  "telegram": {
    "last_update_id": 12345678
  }
}
```|
| `pipeline.auto_subscribe` | Настройки авто-подписки и форс-запуска. |```yaml
pipeline:
  auto_subscribe: true
  force_dispatch_env: "FORCE_DISPATCH"
```|
| Telegram payload | Текст сообщения, который отправляется через Bot API. |```json
{
  "chat_id": "@vietnam_digest",
  "parse_mode": "Markdown",
  "text": "*Политика*\n[Новость](https://...)\u00A0— краткое summary..."
}
```|

### Поток данных

1. GitHub Actions запускает консольное приложение.
2. Модуль `sources` собирает новости со всех RSS/API и возвращает объединённый список `ArticleRaw`.
3. Модуль `filtering` очищает список (фильтрация, дедупликация, исключение уже отправленных).
4. Модуль `categorization` отправляет новости в Gemini батчами и получает для каждой из них категорию.
5. Модуль `ranking` группирует новости по категориям, сортирует и обрезает до N лучших в каждой.
6. Модуль `summarization` запрашивает у Gemini краткие русскоязычные резюме для отобранных новостей.
7. Модуль `formatter` формирует итоговые текстовые блоки для Telegram.
8. Модуль `telegram_sender` отправляет сообщения в канал.
9. Модуль `state` обновляет файл состояния (список отправленных новостей), чтобы избежать дублей в будущих запусках.

### Интеграция с GitHub Actions

- Отдельный workflow (например, `news_daily.yml`):
  - триггер: `schedule` (раз в день) и, опционально, ручной запуск (`workflow_dispatch`);
  - шаги:
    - `checkout` репозитория;
    - установка Go;
    - запуск приложения (`go run ./cmd/dailyjob` или подготовленного бинаря);
    - при необходимости — коммит обновлённого файла состояния обратно в репозиторий.
- Секреты:
  - `GEMINI_API_KEY` для доступа к Gemini Flash;
  - `TELEGRAM_BOT_TOKEN` для отправки сообщений;
  - `GITHUB_TOKEN` (или аналогичный токен) для записи состояния в репозиторий.


